<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Política — Filosofía — Ciencia — Tecnología — Historia — Mitos — Leyendas</title>

  <style>
    :root{
      --bg:#0b0f17; --card:#111a2a; --ink:#e9eefc; --muted:#a9b6d6;
      --line:rgba(255,255,255,.10); --accent:#7aa2ff; --accent2:#57e3ff;
      --chip:rgba(122,162,255,.14);
      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1200px 600px at 20% 0%, rgba(122,162,255,.16), transparent 55%),
                  radial-gradient(900px 500px at 80% 10%, rgba(87,227,255,.14), transparent 55%),
                  var(--bg);
      color:var(--ink);
      min-height:100vh;
    }
    header{
      position:sticky; top:0; z-index:5;
      backdrop-filter: blur(12px);
      background: linear-gradient(to bottom, rgba(11,15,23,.85), rgba(11,15,23,.55));
      border-bottom:1px solid var(--line);
    }
    .wrap{max-width:1180px; margin:0 auto; padding:18px 18px}
    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:14px;
    }
    .brand{
      display:flex; flex-direction:column; gap:2px;
      flex: 1;
    }
    .brand h1{
      margin:0;
      font-size:16px;
      letter-spacing:.3px;
      font-weight:800;
      line-height: 1.3;
    }
    .brand small{color:var(--muted)}
    .logo{
      width:54px; height:54px; border-radius:14px;
      border:1px solid var(--line);
      box-shadow: var(--shadow);
      object-fit:cover;
      background:rgba(255,255,255,.06);
    }

    main{padding:22px 0 34px}
    .controls{
      display:grid;
      grid-template-columns: 1.2fr .6fr .6fr .8fr;
      gap:12px;
      margin-top:14px;
    }
    @media (max-width: 980px){
      .controls{grid-template-columns:1fr 1fr; }
    }
    @media (max-width: 560px){
      .controls{grid-template-columns:1fr;}
      .brand h1 { font-size: 14px; }
    }
    .field{
      background:rgba(255,255,255,.04);
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 12px;
      display:flex; flex-direction:column; gap:6px;
    }
    .field label{font-size:12px; color:var(--muted)}
    input, select{
      background:transparent; border:none; outline:none; color:var(--ink);
      font-size:14px; padding:2px 0;
    }
    input::placeholder{color:rgba(233,238,252,.45)}
    .btnrow{
      display:flex; gap:10px; align-items:end; justify-content:flex-end;
    }
    button{
      cursor:pointer;
      border:1px solid rgba(122,162,255,.35);
      background: linear-gradient(180deg, rgba(122,162,255,.18), rgba(122,162,255,.08));
      color:var(--ink);
      padding:10px 12px;
      border-radius:14px;
      font-weight:700;
      transition: transform .08s ease, border-color .2s ease, background .2s ease;
    }
    button:hover{transform: translateY(-1px); border-color: rgba(87,227,255,.55)}
    button.secondary{
      border-color: rgba(255,255,255,.16);
      background: rgba(255,255,255,.05);
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
      margin-top:18px;
    }
    .card{
      background: linear-gradient(180deg, rgba(17,26,42,.96), rgba(17,26,42,.74));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:14px 14px;
      display:grid;
      grid-template-columns: 1fr auto;
      gap:12px;
      align-items:center;
    }
    .meta{
      display:flex; flex-wrap:wrap; gap:10px; align-items:center;
      margin-top:8px;
    }
    .chip{
      font-size:12px; color:var(--muted);
      border:1px solid rgba(122,162,255,.22);
      background: var(--chip);
      padding:5px 10px;
      border-radius:999px;
    }
    .title{
      margin:0;
      font-size:16px;
      font-weight:850;
      line-height:1.25;
    }
    .actions{
      display:flex; gap:10px; justify-content:flex-end; align-items:center;
      flex-wrap:wrap;
    }
    a.action{
      text-decoration:none;
      border:1px solid rgba(87,227,255,.40);
      background: linear-gradient(180deg, rgba(87,227,255,.16), rgba(87,227,255,.06));
      padding:10px 12px;
      border-radius:14px;
      color:var(--ink);
      font-weight:800;
      font-size:13px;
      white-space:nowrap;
    }
    a.action.secondary{
      border-color: rgba(255,255,255,.16);
      background: rgba(255,255,255,.05);
      color: rgba(233,238,252,.90);
      font-weight:700;
    }

    .status{
      margin-top:12px;
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      color:var(--muted);
      font-size:13px;
    }
    .dot{
      width:8px; height:8px; border-radius:99px;
      background: rgba(87,227,255,.75);
      box-shadow: 0 0 0 4px rgba(87,227,255,.12);
    }
    .error{color:#ffb3b3}
  </style>
</head>

<body>
  <header>
    <div class="wrap">
      <div class="topbar">
        <div class="brand">
          <h1>Política — Filosofía — Ciencia — Tecnología — Historia — Mitos — Leyendas</h1>
          <small>Índice dinámico desde <span class="inline" id="jsonName" style="background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.10); padding: 2px 6px; border-radius: 8px;">articulos.json</span></small>
        </div>

        <img class="logo" src="./LOGO.png" alt="Logo" />
      </div>

      <div class="controls">
        <div class="field">
          <label>Buscar (título / tema / fecha)</label>
          <input id="q" type="text" placeholder="Ej: Ucrania, cuántica, 2025..." />
        </div>

        <div class="field">
          <label>Filtrar por tema</label>
          <select id="tema">
            <option value="">Todos</option>
          </select>
        </div>

        <div class="field">
          <label>Orden</label>
          <select id="orden">
            <option value="fecha_desc">Fecha (nueva → antigua)</option>
            <option value="fecha_asc">Fecha (antigua → nueva)</option>
            <option value="az">Título (A → Z)</option>
            <option value="za">Título (Z → A)</option>
          </select>
        </div>

        <div class="btnrow">
          <button id="recargar">Recargar</button>
          <button id="limpiar" class="secondary">Limpiar</button>
        </div>
      </div>

      <div class="status" id="status">
        <span class="dot"></span>
        <span id="statusText">Listo</span>
      </div>

      <div class="meta" style="margin-top:8px;">
        <span class="chip">Visitas totales: <span id="visitCount">351250</span></span>
        <span class="chip">Aperturas de artículos: <span id="articleOpenCount">0</span></span>
      </div>

    </div>
  </header>

  <main>
    <div class="wrap">
      <div class="grid" id="grid"></div>
    </div>
  </main>

<script>
(() => {
  "use strict";

  /* =========================
     CONTADORES (CountAPI) — SIN /create (offset)
     ========================= */

  const BASE_TOTAL = 351250;                    // contador inicial GitHub Pages
  const BASE_ARTICLES = 0;                      // si quieres un inicial para aperturas, cámbialo
  const COUNTER_TOTAL = "conocimiento_ghpages"; // clave recomendada
  const COUNTER_ARTICLES = "conocimiento_articulos_ghpages";

  function hitWithOffset(key, base, elementId){
    const url = `https://api.countapi.xyz/hit/josr957/${encodeURIComponent(key)}`;
    fetch(url, { cache: "no-store", keepalive: true })
      .then(r => r.json())
      .then(d => {
        const shown = (base - 1) + Number(d.value || 0);
        const el = document.getElementById(elementId);
        if (el) { const v = shown.toLocaleString("es-ES"); el.textContent = v; try{ localStorage.setItem(LS_TOTAL, v); }catch(e){} }
      })
      .catch(() => {
        const el = document.getElementById(elementId);
        if (el) el.textContent = base.toLocaleString("es-ES");
      });
  }

  function incrementSilent(key){
    try{
      const url = `https://api.countapi.xyz/hit/josr957/${encodeURIComponent(key)}`;
      if (navigator.sendBeacon){
        navigator.sendBeacon(url, "");
      } else {
        fetch(url, { keepalive: true });
      }
    }catch(e){}
  }

  // 1) Contar visita al cargar el index (TOTAL) con offset
  hitWithOffset(COUNTER_TOTAL, BASE_TOTAL, "visitCount");

  // 2) Mostrar aperturas de artículos (sin sumar) con offset
  fetch(`https://api.countapi.xyz/get/josr957/${encodeURIComponent(COUNTER_ARTICLES)}`, { cache: "no-store" })
    .then(r => r.json())
    .then(d => {
      const shown = (BASE_ARTICLES - 1) + Number(d.value || 0);
      const el = document.getElementById("articleOpenCount");
      if (el) { const v = shown.toLocaleString("es-ES"); el.textContent = v; try{ localStorage.setItem(LS_ARTICLES, v); }catch(e){} }
    })
    .catch(() => {});

  // 3) Mantener compatibilidad (si algún enlace antiguo aún llama a trackArticleOpen)
  window.trackArticleOpen = function(){
    incrementSilent(COUNTER_ARTICLES);
    incrementSilent(COUNTER_TOTAL);
  };

  /* =========================
     ARTÍCULOS
     ========================= */

  const JSON_FILE = "articulos.json";
  const $ = (id) => document.getElementById(id);

  const els = {
    grid: $("grid"),
    q: $("q"),
    tema: $("tema"),
    orden: $("orden"),
    recargar: $("recargar"),
    limpiar: $("limpiar"),
    statusText: $("statusText"),
    status: $("status")
  };

  let allArticles = [];

  // Delegación de eventos: cuenta aperturas de artículos sin depender de onclick inline
  // (más fiable con target="_blank" y bloqueadores de popups)
  els.grid.addEventListener("click", (ev) => {
    const link = ev.target.closest("a.open-article");
    if (!link) return;

    // incrementa en segundo plano
    incrementSilent(COUNTER_ARTICLES);
    incrementSilent(COUNTER_TOTAL);

    // actualización optimista del contador mostrado (sin esperar respuesta)
    const bump = (id) => {
      const el = document.getElementById(id);
      if (!el) return null;
      const cur = Number(String(el.textContent).replace(/\./g,"").replace(/,/g,"").trim());
      if (Number.isFinite(cur) && cur >= 0) {
        const v = (cur + 1).toLocaleString("es-ES");
        el.textContent = v;
        return v;
      }
      return null;
    };
    const vA = bump("articleOpenCount");
    if (vA) { try{ localStorage.setItem(LS_ARTICLES, vA); }catch(e){} }
    const vT = bump("visitCount");
    if (vT) { try{ localStorage.setItem(LS_TOTAL, vT); }catch(e){} }
  }, { passive: true });


  function setStatus(text, isError=false){
    els.statusText.textContent = text;
    els.statusText.className = isError ? "error" : "";
  }

  function parseDateSmart(s){
    if (!s) return null;
    const str = String(s).trim();
    const iso = str.match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if (iso) return new Date(Number(iso[1]), Number(iso[2]) - 1, Number(iso[3]));
    const dmy = str.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
    if (dmy) return new Date(Number(dmy[3]), Number(dmy[2]) - 1, Number(dmy[1]));
    const dt = new Date(str);
    return isNaN(dt.getTime()) ? null : dt;
  }

  function normalizeArticle(a){
    const nombreRaw = (a?.nombre ?? "").toString();
    const urlRaw = (a?.url ?? "").toString();
    const temaRaw = (a?.tema ?? "").toString();

    const partsNombre = nombreRaw.split(" | ");
    const partsUrl = urlRaw.split(" | ");

    const url = (partsUrl[0] || urlRaw).trim();
    const titulo = (partsNombre[1] || partsUrl[1] || partsNombre[0] || "Sin título").trim();
    const fecha = (partsNombre[2] || partsUrl[2] || a?.fecha || "").toString().trim();
    const tema = temaRaw.trim();

    return {
      ...a,
      url,
      titulo,
      fecha,
      tema,
      _fechaObj: parseDateSmart(fecha)
    };
  }

  function uniqueSorted(arr){
    return [...new Set(arr)].filter(Boolean).sort((a,b)=>a.localeCompare(b, "es", {sensitivity:"base"}));
  }

  function fillTemas(){
    const temas = uniqueSorted(allArticles.map(a => a.tema).filter(Boolean));
    els.tema.innerHTML = `<option value="">Todos</option>` +
      temas.map(t => `<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join("");
  }

  function escapeHtml(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function matchesQuery(article, q){
    if(!q) return true;
    const hay = `${article.titulo} ${article.tema} ${article.fecha}`.toLowerCase();
    return hay.includes(q.toLowerCase());
  }

  function sortArticles(list){
    const mode = els.orden.value;
    const coll = new Intl.Collator("es", {sensitivity:"base"});
    const safeTime = (a) => a._fechaObj ? a._fechaObj.getTime() : -Infinity;

    const out = [...list];
    if (mode === "fecha_desc") out.sort((a,b)=> safeTime(b) - safeTime(a));
    else if (mode === "fecha_asc") out.sort((a,b)=> safeTime(a) - safeTime(b));
    else if (mode === "az") out.sort((a,b)=> coll.compare(a.titulo, b.titulo));
    else if (mode === "za") out.sort((a,b)=> coll.compare(b.titulo, a.titulo));
    return out;
  }

  function render(){
    const q = els.q.value.trim();
    const tema = els.tema.value;

    let filtered = [...allArticles];
    if (tema) filtered = filtered.filter(a => a.tema === tema);
    if (q) filtered = filtered.filter(a => matchesQuery(a, q));

    filtered = sortArticles(filtered);

    if (!filtered.length){
      els.grid.innerHTML = `<div class="card"><div><h3 class="title">No hay resultados</h3></div></div>`;
      setStatus(`0 artículos`);
      return;
    }

    els.grid.innerHTML = filtered.map(a => {
      const fecha = a.fecha ? `<span class="chip">Fecha: ${escapeHtml(a.fecha)}</span>` : "";
      const temaChip = a.tema ? `<span class="chip">Tema: ${escapeHtml(a.tema)}</span>` : "";

      return `
        <div class="card">
          <div>
            <h3 class="title">${escapeHtml(a.titulo)}</h3>
            <div class="meta">${temaChip}${fecha}</div>
          </div>
          <div class="actions">
            <a class="action open-article" href="${escapeHtml(a.url || "#")}" target="_blank" rel="noopener">LEER ARTÍCULO</a>
          </div>
        </div>
      `;
    }).join("");

    setStatus(`${filtered.length} artículos`);
  }

  async function loadArticles(){
    setStatus("Cargando...");
    try{
      const res = await fetch(`${JSON_FILE}?v=${Date.now()}`, { cache: "no-store" });
      const data = await res.json();
      allArticles = data.map(normalizeArticle);
      fillTemas();
      render();
      setStatus(`Cargado: ${allArticles.length} artículos`);
    }catch(err){
      console.error(err);
      setStatus("Error al cargar", true);
    }
  }

  els.q.addEventListener("input", render);
  els.tema.addEventListener("change", render);
  els.orden.addEventListener("change", render);
  els.recargar.addEventListener("click", loadArticles);
  els.limpiar.addEventListener("click", () => { els.q.value = ""; els.tema.value = ""; render(); });

  loadArticles();
})();
</script>
</body>
</html>
